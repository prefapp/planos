nombre: wordpress

autor: "Equipo PrefApp"

version: 0.1

descripcion: >
  CMS por excelencia para la creaci√≥n de blogs o webs de contenidos

category: application

tags:
  - blog
  - web

construcciones: 

  app: 

    role: wordpress

    imagen_base: prefapp/wordpress

    expose:
      - 80

    volumes:
      - "#{target_path}/wp-content/uploads"

    links:
      - "db:#{db_host}"
 
    environment: 
      WP_CONTENT_DIR: "#{target_path}/wp-content"
      WP_DB_NAME: "#{db_name}"
      WP_DB_USER: "#{db_user}"
      WP_DB_PASSWORD: "#{db_password}"
      WP_DB_HOST: "#{db_host}"
      WP_CACHE: "#{enable_wp_cache}"
      DISABLE_WP_CRON: "#{disable_wp_cron}"
      WP_MEMORY_LIMIT: "#{wp_memory_limit}"
      WP_SITEURL: "#{wp_siteurl}"

    parameters:      
      
      domain:

        user_provided: 1

        riyic:
          name: "app/wordpress/domain"
          recipe: "app_wordpress::deploy"

      alias:

        user_provided: 1

        riyic:
          name: "app/wordpress/alias"
          recipe: "app_wordpress::deploy"

      wp_siteurl:
        user_provided: 1
        variable:
          default_value: ''

      wp_memory_limit:
        user_provided: 1
        variable:
          default_value: 128M

      enable_wp_cache:
        user_provided: 1
        variable:
          default_value: 0

      disable_wp_cron:
        user_provided: 1
        variable:
          default_value: 0

      php_version:
        riyic:
          name: "lang/php/version"
          recipe: "lang_php::default"
        value: "7.1"
        user_provided: 1

      # 
      # a partir de aqui xa non son user_provided
      #
      target_path:
        riyic:
          name: "app/wordpress/target_path"
          recipe: "app_wordpress::deploy"


      db_name:

        riyic:
          name: "app/wordpress/db_name"
          recipe: "app_wordpress::deploy"

        value: "wp_db"


      db_user:
        riyic:
          name: "app/wordpress/db_user"
          recipe: "app_wordpress::deploy"

        value: "wp_user"


      db_host:
        riyic:
          name: "app/wordpress/db_host"
          recipe: "app_wordpress::deploy"

        value: "db.wp"

      db_password:

        riyic:
          name: "app/wordpress/db_password"
          recipe: "app_wordpress::deploy"

        value: "passw0rd"

      use_ssl:
        user_provided: 1
        variable:
          display_name: "Enable https with an autogenerated letsencrypt certificate"
          field_type: "radio"
          validations:
            fixed_values:
              - "yes"
              - "no"
          default_value: "no"


    tasks:
      backup_content:
        command:  "tar xzf /opt/logs/nginx/wp.tar.gz $WP_CONTENT"
        programmable: 1
      

  db:

    role: wordpress_db
    imagen_base: prefapp/mysql

    command: "/root/start.sh"

    expose: 

      - 3306

    volumes:

      - "/var/lib/mysql/"

    
    parameters:

      db_name:
        riyic: 

          name: "dbs/mysql/dbs/[0]/name"
          recipe: "dbs_mysql::create_db"

        value: "@{app}#{db_name}"

      db_user:
        riyic: 

          name: "dbs/mysql/dbs/[0]/user"
          recipe: "dbs_mysql::create_db"

        value: "@{app}#{db_user}"


      db_password:
        riyic: 

          name: "dbs/mysql/dbs/[0]/password"
          recipe: "dbs_mysql::create_db"

        value: "@{app}#{db_password}"
      
      root_password:

        riyic: 

          name: "dbs/mysql/server/root_password"
          recipe: "dbs_mysql::server"

        value: "password"

  proxy-letsencrypt:
    from: "ssl_letsencrypt:0.1@proxy-letsencrypt"

  proxy:
    from: "common:0.1@proxy-http"
