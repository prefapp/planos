nombre: moodle

autor: "Equipo PrefApp"

descripcion: >

  Plataforma opensource para la gesti√≥n de cursos y aprendizaje en linea

version: 0.1

category: application

tags: 
  - education
  - web

construcciones: 

  app: 

    role: moodle_app

    imagen_base: ubuntu:14.04

    expose:
      - 80

    volumes:
      - "#{datadir}"

    links:
      - "db:#{db_host}"
 
    environment:
      MOODLE_BASE_URL: "#{base_url}" 

    parameters:      
      
      php_version:
        user_provided: 1
        riyic:
          name: "lang/php/version"
          recipe: "lang_php::default"


      base_url:
        user_provided: 1
        variable:
          display_name: "Base URL for this installation"
          validations:
            predefined: 'url'
          default_value: 'http://change-me/moodle'

      admin_user:
        user_provided: 1
        riyic:
          name: "app/moodle/admin_user"
          recipe: "app_moodle::deploy"

      admin_password:
        user_provided: 1
        riyic:
          name: "app/moodle/admin_password"
          recipe: "app_moodle::deploy"


      # 
      # a partir de aqui xa non son user_provided
      #
      domain:
        riyic:
          name: "app/moodle/domain"
          recipe: "app_moodle::deploy"
        value: default

      target_path:
        riyic:
          name: "app/moodle/target_path"
          recipe: "app_moodle::deploy"
        value: "/home/moodle/public"

      datadir:
        riyic: 
          name: "app/moodle/datadir" 
          recipe: "app_moodle::deploy"
        value: "/home/moodle/moodledata"


      db_name:
        riyic:
          name: "app/moodle/db_name"
          recipe: "app_moodle::deploy"

        value: "moodle_db"

      db_type:
        riyic:
          name: "app/moodle/db_type"
          recipe: "app_moodle::deploy"
        value: "mysqli"


      db_user:
        riyic:
          name: "app/moodle/db_user"
          recipe: "app_moodle::deploy"

        value: "moodle_user"


      db_host:
        riyic:
          name: "app/moodle/db_host"
          recipe: "app_moodle::deploy"

        value: "db.wp"

      db_password:
        riyic:
          name: "app/moodle/db_password"
          recipe: "app_moodle::deploy"

        value: "passw0rd"

      use_ssl:
        user_provided: 1
        variable:
          display_name: "Enable https with an autogenerated letsencrypt certificate"
          field_type: "radio"
          validations:
            fixed_values:
              - "yes"
              - "no"
          default_value: "no"


    tasks:
      backup_content:
        command:  ""
        programmable: 1
      

  db:

    role: mysql_db
    imagen_base: ubuntu:16.04

    command: "/root/start.sh"

    expose: 

      - 3306

    volumes:

      - "/var/lib/mysql/"

    
    parameters:

      db_name:
        riyic: 

          name: "dbs/mysql/dbs/[0]/name"
          recipe: "dbs_mysql::create_db"

        value: "@{app}#{db_name}"

      db_user:
        riyic: 

          name: "dbs/mysql/dbs/[0]/user"
          recipe: "dbs_mysql::create_db"

        value: "@{app}#{db_user}"


      db_password:
        riyic: 

          name: "dbs/mysql/dbs/[0]/password"
          recipe: "dbs_mysql::create_db"

        value: "@{app}#{db_password}"
      
      root_password:

        riyic: 

          name: "dbs/mysql/server/root_password"
          recipe: "dbs_mysql::server"

        value: "password"

  proxy-letsencrypt:
    from: "ssl_letsencrypt:0.1@proxy-letsencrypt"

  proxy:
    from: "common:0.1@proxy-http"
